{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "10915401-7afb-4009-8c78-3f04cf229d2f",
   "metadata": {},
   "source": [
    "# Prediction Interface – Uber Taxi Fare Prediction\n",
    "\n",
    "In this notebook, we:\n",
    "1. Load the cleaned Uber taxi fare dataset  \n",
    "2. Train a regression model (Random Forest)  \n",
    "3. Build a simple prediction interface that takes:\n",
    "   - Pickup datetime  \n",
    "   - Pickup and dropoff coordinates  \n",
    "   - Passenger count  \n",
    "   and returns the predicted fare amount.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "82e4a7bf-2d60-436d-92a0-f8fd7e4787e5",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Loaded dataset from: C:\\Users\\USER\\OneDrive\\Belgeler\\uber.csv\n",
      "Shape: (200000, 9)\n",
      "Columns: ['Unnamed: 0', 'key', 'fare_amount', 'pickup_datetime', 'pickup_longitude', 'pickup_latitude', 'dropoff_longitude', 'dropoff_latitude', 'passenger_count']\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Unnamed: 0</th>\n",
       "      <th>key</th>\n",
       "      <th>fare_amount</th>\n",
       "      <th>pickup_datetime</th>\n",
       "      <th>pickup_longitude</th>\n",
       "      <th>pickup_latitude</th>\n",
       "      <th>dropoff_longitude</th>\n",
       "      <th>dropoff_latitude</th>\n",
       "      <th>passenger_count</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>24238194</td>\n",
       "      <td>2015-05-07 19:52:06.0000003</td>\n",
       "      <td>7.5</td>\n",
       "      <td>2015-05-07 19:52:06 UTC</td>\n",
       "      <td>-73.999817</td>\n",
       "      <td>40.738354</td>\n",
       "      <td>-73.999512</td>\n",
       "      <td>40.723217</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>27835199</td>\n",
       "      <td>2009-07-17 20:04:56.0000002</td>\n",
       "      <td>7.7</td>\n",
       "      <td>2009-07-17 20:04:56 UTC</td>\n",
       "      <td>-73.994355</td>\n",
       "      <td>40.728225</td>\n",
       "      <td>-73.994710</td>\n",
       "      <td>40.750325</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>44984355</td>\n",
       "      <td>2009-08-24 21:45:00.00000061</td>\n",
       "      <td>12.9</td>\n",
       "      <td>2009-08-24 21:45:00 UTC</td>\n",
       "      <td>-74.005043</td>\n",
       "      <td>40.740770</td>\n",
       "      <td>-73.962565</td>\n",
       "      <td>40.772647</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>25894730</td>\n",
       "      <td>2009-06-26 08:22:21.0000001</td>\n",
       "      <td>5.3</td>\n",
       "      <td>2009-06-26 08:22:21 UTC</td>\n",
       "      <td>-73.976124</td>\n",
       "      <td>40.790844</td>\n",
       "      <td>-73.965316</td>\n",
       "      <td>40.803349</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>17610152</td>\n",
       "      <td>2014-08-28 17:47:00.000000188</td>\n",
       "      <td>16.0</td>\n",
       "      <td>2014-08-28 17:47:00 UTC</td>\n",
       "      <td>-73.925023</td>\n",
       "      <td>40.744085</td>\n",
       "      <td>-73.973082</td>\n",
       "      <td>40.761247</td>\n",
       "      <td>5</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   Unnamed: 0                            key  fare_amount  \\\n",
       "0    24238194    2015-05-07 19:52:06.0000003          7.5   \n",
       "1    27835199    2009-07-17 20:04:56.0000002          7.7   \n",
       "2    44984355   2009-08-24 21:45:00.00000061         12.9   \n",
       "3    25894730    2009-06-26 08:22:21.0000001          5.3   \n",
       "4    17610152  2014-08-28 17:47:00.000000188         16.0   \n",
       "\n",
       "           pickup_datetime  pickup_longitude  pickup_latitude  \\\n",
       "0  2015-05-07 19:52:06 UTC        -73.999817        40.738354   \n",
       "1  2009-07-17 20:04:56 UTC        -73.994355        40.728225   \n",
       "2  2009-08-24 21:45:00 UTC        -74.005043        40.740770   \n",
       "3  2009-06-26 08:22:21 UTC        -73.976124        40.790844   \n",
       "4  2014-08-28 17:47:00 UTC        -73.925023        40.744085   \n",
       "\n",
       "   dropoff_longitude  dropoff_latitude  passenger_count  \n",
       "0         -73.999512         40.723217                1  \n",
       "1         -73.994710         40.750325                1  \n",
       "2         -73.962565         40.772647                1  \n",
       "3         -73.965316         40.803349                3  \n",
       "4         -73.973082         40.761247                5  "
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "import warnings\n",
    "\n",
    "warnings.filterwarnings(\"ignore\")\n",
    "\n",
    "# Load the cleaned dataset (from 02_feature_engineering.ipynb)\n",
    "# Adjust the path if needed:\n",
    "file_path = r\"C:\\Users\\USER\\OneDrive\\Belgeler\\uber.csv\"\n",
    "# or, if the file is in the same folder as this notebook:\n",
    "# file_path = \"uber_cleaned_data.csv\"\n",
    "\n",
    "df = pd.read_csv(file_path)\n",
    "\n",
    "print(\"Loaded dataset from:\", file_path)\n",
    "print(\"Shape:\", df.shape)\n",
    "print(\"Columns:\", df.columns.tolist())\n",
    "\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "bcb5a9a4-48ed-4b23-9360-d41ccb31374b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Using features: ['passenger_count']\n",
      "X_train shape: (160000, 1)\n",
      "X_test shape: (40000, 1)\n",
      "Model performance on test set:\n",
      "  RMSE: 10.309\n",
      "  MAE : 6.106\n",
      "  R2  : 0.000\n"
     ]
    }
   ],
   "source": [
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.ensemble import RandomForestRegressor\n",
    "from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score\n",
    "\n",
    "# Define target and features (must match what you used before)\n",
    "target_col = \"fare_amount\"\n",
    "\n",
    "feature_cols = [\n",
    "    \"pickup_year\",\n",
    "    \"pickup_month\",\n",
    "    \"pickup_day\",\n",
    "    \"pickup_hour\",\n",
    "    \"pickup_weekday\",\n",
    "    \"passenger_count\",\n",
    "    \"distance_km\"\n",
    "]\n",
    "\n",
    "# Only keep columns that exist\n",
    "available_features = [col for col in feature_cols if col in df.columns]\n",
    "print(\"Using features:\", available_features)\n",
    "\n",
    "X = df[available_features]\n",
    "y = df[target_col]\n",
    "\n",
    "X_train, X_test, y_train, y_test = train_test_split(\n",
    "    X, y,\n",
    "    test_size=0.2,\n",
    "    random_state=42\n",
    ")\n",
    "\n",
    "print(\"X_train shape:\", X_train.shape)\n",
    "print(\"X_test shape:\", X_test.shape)\n",
    "\n",
    "# Train a Random Forest model\n",
    "model = RandomForestRegressor(\n",
    "    n_estimators=100,\n",
    "    random_state=42,\n",
    "    n_jobs=-1\n",
    ")\n",
    "\n",
    "model.fit(X_train, y_train)\n",
    "\n",
    "# Quick evaluation\n",
    "y_pred = model.predict(X_test)\n",
    "rmse = np.sqrt(mean_squared_error(y_test, y_pred))\n",
    "mae = mean_absolute_error(y_test, y_pred)\n",
    "r2 = r2_score(y_test, y_pred)\n",
    "\n",
    "print(f\"Model performance on test set:\")\n",
    "print(f\"  RMSE: {rmse:.3f}\")\n",
    "print(f\"  MAE : {mae:.3f}\")\n",
    "print(f\"  R2  : {r2:.3f}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "c4d01b1e-5c81-4be4-aaa7-682d256da40f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Test distance (km): 69.94042916169451\n"
     ]
    }
   ],
   "source": [
    "# Haversine distance function with its own numpy import\n",
    "\n",
    "import numpy as np  # make sure numpy is available in this cell\n",
    "\n",
    "def haversine_distance(lat1, lon1, lat2, lon2):\n",
    "    \"\"\"\n",
    "    Calculate the great-circle distance between two points on the Earth\n",
    "    specified in decimal degrees. Returns distance in kilometers.\n",
    "    Works with both scalars and numpy/pandas arrays.\n",
    "    \"\"\"\n",
    "    R = 6371.0  # Earth radius in kilometers\n",
    "\n",
    "    # Convert all inputs to radians\n",
    "    lat1 = np.radians(lat1)\n",
    "    lon1 = np.radians(lon1)\n",
    "    lat2 = np.radians(lat2)\n",
    "    lon2 = np.radians(lon2)\n",
    "\n",
    "    # Differences\n",
    "    dlat = lat2 - lat1\n",
    "    dlon = dlon = lon2 - lon1\n",
    "\n",
    "    # Haversine formula\n",
    "    a = np.sin(dlat / 2.0) ** 2 + np.cos(lat1) * np.cos(lat2) * np.sin(dlon / 2.0) ** 2\n",
    "    c = 2 * np.arctan2(np.sqrt(a), np.sqrt(1.0 - a))\n",
    "\n",
    "    distance = R * c\n",
    "    return distance\n",
    "\n",
    "# Quick test – this should print a positive distance (in km)\n",
    "test_distance = haversine_distance(40.0, -73.0, 40.5, -73.5)\n",
    "print(\"Test distance (km):\", test_distance)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "d7398767-7bf5-4f03-ba4b-73dfa6f9cb8c",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Using FEATURE_COLS from X: ['passenger_count']\n"
     ]
    }
   ],
   "source": [
    "# Build a feature row from raw user input\n",
    "# This cell assumes:\n",
    "# - X (training features) already exists from the previous cell\n",
    "# - haversine_distance function is already defined\n",
    "\n",
    "from datetime import datetime\n",
    "import pandas as pd\n",
    "\n",
    "# Make sure FEATURE_COLS matches the columns used for training\n",
    "try:\n",
    "    FEATURE_COLS = list(X.columns)\n",
    "    print(\"Using FEATURE_COLS from X:\", FEATURE_COLS)\n",
    "except NameError:\n",
    "    # Fallback in case X is not available\n",
    "    FEATURE_COLS = [\n",
    "        \"pickup_year\",\n",
    "        \"pickup_month\",\n",
    "        \"pickup_day\",\n",
    "        \"pickup_hour\",\n",
    "        \"pickup_weekday\",\n",
    "        \"passenger_count\",\n",
    "        \"distance_km\"\n",
    "    ]\n",
    "    print(\"X not found, using default FEATURE_COLS:\", FEATURE_COLS)\n",
    "\n",
    "\n",
    "def build_feature_row(\n",
    "    pickup_datetime_str: str,\n",
    "    pickup_latitude: float,\n",
    "    pickup_longitude: float,\n",
    "    dropoff_latitude: float,\n",
    "    dropoff_longitude: float,\n",
    "    passenger_count: int\n",
    "):\n",
    "    \"\"\"\n",
    "    Convert raw input values into a single-row DataFrame\n",
    "    with the same features used during training.\n",
    "\n",
    "    pickup_datetime_str example: \"2015-01-10 10:30:00\" or \"2015-01-10 10:30\"\n",
    "    \"\"\"\n",
    "\n",
    "    # 1. Parse datetime string (allow with or without seconds)\n",
    "    try:\n",
    "        pickup_dt = datetime.strptime(pickup_datetime_str, \"%Y-%m-%d %H:%M:%S\")\n",
    "    except ValueError:\n",
    "        # Try format without seconds\n",
    "        pickup_dt = datetime.strptime(pickup_datetime_str, \"%Y-%m-%d %H:%M\")\n",
    "\n",
    "    pickup_year = pickup_dt.year\n",
    "    pickup_month = pickup_dt.month\n",
    "    pickup_day = pickup_dt.day\n",
    "    pickup_hour = pickup_dt.hour\n",
    "    pickup_weekday = pickup_dt.weekday()  # Monday = 0\n",
    "\n",
    "    # 2. Calculate distance in km\n",
    "    distance_km = haversine_distance(\n",
    "        pickup_latitude,\n",
    "        pickup_longitude,\n",
    "        dropoff_latitude,\n",
    "        dropoff_longitude\n",
    "    )\n",
    "\n",
    "    # 3. Build a dictionary with all possible features\n",
    "    row_dict = {\n",
    "        \"pickup_year\": pickup_year,\n",
    "        \"pickup_month\": pickup_month,\n",
    "        \"pickup_day\": pickup_day,\n",
    "        \"pickup_hour\": pickup_hour,\n",
    "        \"pickup_weekday\": pickup_weekday,\n",
    "        \"passenger_count\": passenger_count,\n",
    "        \"distance_km\": distance_km,\n",
    "    }\n",
    "\n",
    "    # 4. Keep only the columns actually used in training\n",
    "    filtered_dict = {col: [row_dict[col]] for col in FEATURE_COLS}\n",
    "\n",
    "    # 5. Create a single-row DataFrame\n",
    "    X_new = pd.DataFrame(filtered_dict)\n",
    "\n",
    "    return X_new\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "880b6611-11e5-41a5-8517-10571eb92a23",
   "metadata": {},
   "outputs": [],
   "source": [
    "def predict_fare(\n",
    "    pickup_datetime_str,\n",
    "    pickup_latitude,\n",
    "    pickup_longitude,\n",
    "    dropoff_latitude,\n",
    "    dropoff_longitude,\n",
    "    passenger_count\n",
    "):\n",
    "    \"\"\"\n",
    "    High-level function that:\n",
    "    - builds feature row from raw input\n",
    "    - uses the trained model to predict fare\n",
    "    \"\"\"\n",
    "    X_new = build_feature_row(\n",
    "        pickup_datetime_str,\n",
    "        pickup_latitude,\n",
    "        pickup_longitude,\n",
    "        dropoff_latitude,\n",
    "        dropoff_longitude,\n",
    "        passenger_count\n",
    "    )\n",
    "\n",
    "    predicted_fare = model.predict(X_new)[0]\n",
    "    return predicted_fare\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "b0c7d9ac-35cb-4b7f-984c-8ab9a463ecc0",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Predicted fare (USD): 11.81\n"
     ]
    }
   ],
   "source": [
    "# Example test prediction\n",
    "pickup_datetime_str = \"2015-01-10 10:30:00\"\n",
    "pickup_latitude = 40.7614327\n",
    "pickup_longitude = -73.9798156\n",
    "dropoff_latitude = 40.6513111\n",
    "dropoff_longitude = -73.8803331\n",
    "passenger_count = 2\n",
    "\n",
    "fare = predict_fare(\n",
    "    pickup_datetime_str,\n",
    "    pickup_latitude,\n",
    "    pickup_longitude,\n",
    "    dropoff_latitude,\n",
    "    dropoff_longitude,\n",
    "    passenger_count\n",
    ")\n",
    "\n",
    "print(\"Predicted fare (USD):\", round(fare, 2))\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "f67273fe-87f1-4979-8e1d-1fd1cf75008b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Index(['passenger_count'], dtype='object')\n"
     ]
    }
   ],
   "source": [
    "print(X.columns)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "0663597a-f3b8-4ea6-9ad2-4e0cfcb37527",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Unnamed: 0</th>\n",
       "      <th>key</th>\n",
       "      <th>fare_amount</th>\n",
       "      <th>pickup_datetime</th>\n",
       "      <th>pickup_longitude</th>\n",
       "      <th>pickup_latitude</th>\n",
       "      <th>dropoff_longitude</th>\n",
       "      <th>dropoff_latitude</th>\n",
       "      <th>passenger_count</th>\n",
       "      <th>pickup_year</th>\n",
       "      <th>pickup_month</th>\n",
       "      <th>pickup_day</th>\n",
       "      <th>pickup_hour</th>\n",
       "      <th>pickup_weekday</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>24238194</td>\n",
       "      <td>2015-05-07 19:52:06.0000003</td>\n",
       "      <td>7.5</td>\n",
       "      <td>2015-05-07 19:52:06+00:00</td>\n",
       "      <td>-73.999817</td>\n",
       "      <td>40.738354</td>\n",
       "      <td>-73.999512</td>\n",
       "      <td>40.723217</td>\n",
       "      <td>1</td>\n",
       "      <td>2015</td>\n",
       "      <td>5</td>\n",
       "      <td>7</td>\n",
       "      <td>19</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>27835199</td>\n",
       "      <td>2009-07-17 20:04:56.0000002</td>\n",
       "      <td>7.7</td>\n",
       "      <td>2009-07-17 20:04:56+00:00</td>\n",
       "      <td>-73.994355</td>\n",
       "      <td>40.728225</td>\n",
       "      <td>-73.994710</td>\n",
       "      <td>40.750325</td>\n",
       "      <td>1</td>\n",
       "      <td>2009</td>\n",
       "      <td>7</td>\n",
       "      <td>17</td>\n",
       "      <td>20</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>44984355</td>\n",
       "      <td>2009-08-24 21:45:00.00000061</td>\n",
       "      <td>12.9</td>\n",
       "      <td>2009-08-24 21:45:00+00:00</td>\n",
       "      <td>-74.005043</td>\n",
       "      <td>40.740770</td>\n",
       "      <td>-73.962565</td>\n",
       "      <td>40.772647</td>\n",
       "      <td>1</td>\n",
       "      <td>2009</td>\n",
       "      <td>8</td>\n",
       "      <td>24</td>\n",
       "      <td>21</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>25894730</td>\n",
       "      <td>2009-06-26 08:22:21.0000001</td>\n",
       "      <td>5.3</td>\n",
       "      <td>2009-06-26 08:22:21+00:00</td>\n",
       "      <td>-73.976124</td>\n",
       "      <td>40.790844</td>\n",
       "      <td>-73.965316</td>\n",
       "      <td>40.803349</td>\n",
       "      <td>3</td>\n",
       "      <td>2009</td>\n",
       "      <td>6</td>\n",
       "      <td>26</td>\n",
       "      <td>8</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>17610152</td>\n",
       "      <td>2014-08-28 17:47:00.000000188</td>\n",
       "      <td>16.0</td>\n",
       "      <td>2014-08-28 17:47:00+00:00</td>\n",
       "      <td>-73.925023</td>\n",
       "      <td>40.744085</td>\n",
       "      <td>-73.973082</td>\n",
       "      <td>40.761247</td>\n",
       "      <td>5</td>\n",
       "      <td>2014</td>\n",
       "      <td>8</td>\n",
       "      <td>28</td>\n",
       "      <td>17</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   Unnamed: 0                            key  fare_amount  \\\n",
       "0    24238194    2015-05-07 19:52:06.0000003          7.5   \n",
       "1    27835199    2009-07-17 20:04:56.0000002          7.7   \n",
       "2    44984355   2009-08-24 21:45:00.00000061         12.9   \n",
       "3    25894730    2009-06-26 08:22:21.0000001          5.3   \n",
       "4    17610152  2014-08-28 17:47:00.000000188         16.0   \n",
       "\n",
       "            pickup_datetime  pickup_longitude  pickup_latitude  \\\n",
       "0 2015-05-07 19:52:06+00:00        -73.999817        40.738354   \n",
       "1 2009-07-17 20:04:56+00:00        -73.994355        40.728225   \n",
       "2 2009-08-24 21:45:00+00:00        -74.005043        40.740770   \n",
       "3 2009-06-26 08:22:21+00:00        -73.976124        40.790844   \n",
       "4 2014-08-28 17:47:00+00:00        -73.925023        40.744085   \n",
       "\n",
       "   dropoff_longitude  dropoff_latitude  passenger_count  pickup_year  \\\n",
       "0         -73.999512         40.723217                1         2015   \n",
       "1         -73.994710         40.750325                1         2009   \n",
       "2         -73.962565         40.772647                1         2009   \n",
       "3         -73.965316         40.803349                3         2009   \n",
       "4         -73.973082         40.761247                5         2014   \n",
       "\n",
       "   pickup_month  pickup_day  pickup_hour  pickup_weekday  \n",
       "0             5           7           19               3  \n",
       "1             7          17           20               4  \n",
       "2             8          24           21               0  \n",
       "3             6          26            8               4  \n",
       "4             8          28           17               3  "
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime\n",
    "\n",
    "# -------- MINI FEATURE ENGINEERING --------\n",
    "# This recreates all the features needed for the model,\n",
    "# so X.columns includes ALL features (not only passenger_count).\n",
    "\n",
    "def create_features(df):\n",
    "    # Convert pickup_datetime to datetime format if needed\n",
    "    df['pickup_datetime'] = pd.to_datetime(df['pickup_datetime'], errors='coerce')\n",
    "\n",
    "    # Extract datetime-based features\n",
    "    df['pickup_year'] = df['pickup_datetime'].dt.year\n",
    "    df['pickup_month'] = df['pickup_datetime'].dt.month\n",
    "    df['pickup_day'] = df['pickup_datetime'].dt.day\n",
    "    df['pickup_hour'] = df['pickup_datetime'].dt.hour\n",
    "    df['pickup_weekday'] = df['pickup_datetime'].dt.weekday  # Monday = 0\n",
    "    \n",
    "    return df\n",
    "\n",
    "# Load your cleaned data again\n",
    "file_path = r\"C:\\Users\\USER\\OneDrive\\Belgeler\\uber.csv\"\n",
    "df = pd.read_csv(file_path)\n",
    "\n",
    "# Add datetime features\n",
    "df = create_features(df)\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "0865aa46-0968-4235-a3f8-a37f71f4e4dd",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>distance_km</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1.683323</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2.457590</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>5.036377</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>1.661683</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>4.475450</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   distance_km\n",
       "0     1.683323\n",
       "1     2.457590\n",
       "2     5.036377\n",
       "3     1.661683\n",
       "4     4.475450"
      ]
     },
     "execution_count": 17,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import numpy as np\n",
    "\n",
    "def haversine_distance(lat1, lon1, lat2, lon2):\n",
    "    R = 6371.0\n",
    "\n",
    "    lat1 = np.radians(lat1)\n",
    "    lon1 = np.radians(lon1)\n",
    "    lat2 = np.radians(lat2)\n",
    "    lon2 = np.radians(lon2)\n",
    "\n",
    "    dlat = lat2 - lat1\n",
    "    dlon = lon2 - lon1\n",
    "\n",
    "    a = np.sin(dlat/2)**2 + np.cos(lat1)*np.cos(lat2)*np.sin(dlon/2)**2\n",
    "    c = 2*np.arctan2(np.sqrt(a), np.sqrt(1-a))\n",
    "\n",
    "    return R * c\n",
    "\n",
    "df['distance_km'] = haversine_distance(\n",
    "    df['pickup_latitude'],\n",
    "    df['pickup_longitude'],\n",
    "    df['dropoff_latitude'],\n",
    "    df['dropoff_longitude']\n",
    ")\n",
    "\n",
    "df[['distance_km']].head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "a048fa9a-0850-49bd-8140-fb9a42971941",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "FEATURE COLS: ['pickup_year', 'pickup_month', 'pickup_day', 'pickup_hour', 'pickup_weekday', 'passenger_count', 'distance_km']\n",
      "X shape: (200000, 7)  y shape: (200000,)\n"
     ]
    }
   ],
   "source": [
    "feature_cols = [\n",
    "    \"pickup_year\",\n",
    "    \"pickup_month\",\n",
    "    \"pickup_day\",\n",
    "    \"pickup_hour\",\n",
    "    \"pickup_weekday\",\n",
    "    \"passenger_count\",\n",
    "    \"distance_km\"\n",
    "]\n",
    "\n",
    "X = df[feature_cols]\n",
    "y = df[\"fare_amount\"]\n",
    "\n",
    "print(\"FEATURE COLS:\", X.columns.tolist())\n",
    "print(\"X shape:\", X.shape, \" y shape:\", y.shape)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "bfc0a345-9718-4b06-88c9-81ffadb226f2",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Model trained successfully!\n"
     ]
    }
   ],
   "source": [
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.ensemble import RandomForestRegressor\n",
    "X_train, X_test, y_train, y_test = train_test_split(\n",
    "    X, y,\n",
    "    test_size=0.2,\n",
    "    random_state=42)\n",
    "model = RandomForestRegressor(\n",
    "    n_estimators=100,\n",
    "    random_state=42,\n",
    "    n_jobs=-1)\n",
    "model.fit(X_train, y_train)\n",
    "print(\"Model trained successfully!\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "0df81467-340f-4940-be7b-98bdf45fba62",
   "metadata": {},
   "outputs": [],
   "source": [
    "from datetime import datetime\n",
    "def build_feature_row(\n",
    "    pickup_datetime_str,\n",
    "    pickup_latitude,\n",
    "    pickup_longitude,\n",
    "    dropoff_latitude,\n",
    "    dropoff_longitude,\n",
    "    passenger_count):\n",
    "    pickup_dt = datetime.strptime(pickup_datetime_str, \"%Y-%m-%d %H:%M:%S\")\n",
    "    pickup_year = pickup_dt.year\n",
    "    pickup_month = pickup_dt.month\n",
    "    pickup_day = pickup_dt.day\n",
    "    pickup_hour = pickup_dt.hour\n",
    "    pickup_weekday = pickup_dt.weekday()\n",
    "    distance_km = haversine_distance(\n",
    "        pickup_latitude,\n",
    "        pickup_longitude,\n",
    "        dropoff_latitude,\n",
    "        dropoff_longitude)\n",
    "    row = pd.DataFrame([{\n",
    "        \"pickup_year\": pickup_year,\n",
    "        \"pickup_month\": pickup_month,\n",
    "        \"pickup_day\": pickup_day,\n",
    "        \"pickup_hour\": pickup_hour,\n",
    "        \"pickup_weekday\": pickup_weekday,\n",
    "        \"passenger_count\": passenger_count,\n",
    "        \"distance_km\": distance_km}])\n",
    "    return row"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "6e6711ae-08af-4b82-93b9-310cfd1dcd5c",
   "metadata": {},
   "outputs": [],
   "source": [
    "def predict_fare(\n",
    "    pickup_datetime_str,\n",
    "    pickup_latitude,\n",
    "    pickup_longitude,\n",
    "    dropoff_latitude,\n",
    "    dropoff_longitude,\n",
    "    passenger_count\n",
    "):\n",
    "    X_new = build_feature_row(\n",
    "        pickup_datetime_str,\n",
    "        pickup_latitude,\n",
    "        pickup_longitude,\n",
    "        dropoff_latitude,\n",
    "        dropoff_longitude,\n",
    "        passenger_count\n",
    "    )\n",
    "    \n",
    "    return model.predict(X_new)[0]\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "847a32f2-975f-4aad-a0ea-f19119ef5569",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Predicted fare: 43.71\n"
     ]
    }
   ],
   "source": [
    "fare = predict_fare(\n",
    "    \"2015-01-10 10:30:00\",\n",
    "    40.7614327,\n",
    "    -73.9798156,\n",
    "    40.6513111,\n",
    "    -73.8803331,\n",
    "    2\n",
    ")\n",
    "\n",
    "print(\"Predicted fare:\", round(fare, 2))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "85d169e8-432c-45ef-8d06-5ac0e296472d",
   "metadata": {},
   "outputs": [
    {
     "ename": "IndentationError",
     "evalue": "expected an indented block after function definition on line 29 (247598587.py, line 36)",
     "output_type": "error",
     "traceback": [
      "  \u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[27]\u001b[39m\u001b[32m, line 36\u001b[39m\n\u001b[31m    \u001b[39m\u001b[31mX_new = build_feature_row(\u001b[39m\n    ^\n\u001b[31mIndentationError\u001b[39m\u001b[31m:\u001b[39m expected an indented block after function definition on line 29\n"
     ]
    }
   ],
   "source": [
    "from datetime import datetime\n",
    "def build_feature_row(\n",
    "    pickup_datetime_str,\n",
    "    pickup_latitude,\n",
    "    pickup_longitude,\n",
    "    dropoff_latitude,\n",
    "    dropoff_longitude,\n",
    "    passenger_count):\n",
    "    pickup_dt = datetime.strptime(pickup_datetime_str, \"%Y-%m-%d %H:%M:%S\")\n",
    "    pickup_year = pickup_dt.year\n",
    "    pickup_month = pickup_dt.month\n",
    "    pickup_day = pickup_dt.day\n",
    "    pickup_hour = pickup_dt.hour\n",
    "    pickup_weekday = pickup_dt.weekday()\n",
    "    distance_km = haversine_distance(\n",
    "        pickup_latitude,\n",
    "        pickup_longitude,\n",
    "        dropoff_latitude,\n",
    "        dropoff_longitude)\n",
    "    row = pd.DataFrame([{\n",
    "        \"pickup_year\": pickup_year,\n",
    "        \"pickup_month\": pickup_month,\n",
    "        \"pickup_day\": pickup_day,\n",
    "        \"pickup_hour\": pickup_hour,\n",
    "        \"pickup_weekday\": pickup_weekday,\n",
    "        \"passenger_count\": passenger_count,\n",
    "        \"distance_km\": distance_km}])\n",
    "    return row\n",
    "    def predict_fare(\n",
    "    pickup_datetime_str,\n",
    "    pickup_latitude,\n",
    "    pickup_longitude,\n",
    "    dropoff_latitude,\n",
    "    dropoff_longitude,\n",
    "    passenger_count):\n",
    "    X_new = build_feature_row(\n",
    "        pickup_datetime_str,\n",
    "        pickup_latitude,\n",
    "        pickup_longitude,\n",
    "        dropoff_latitude,\n",
    "        dropoff_longitude,\n",
    "        passenger_count)\n",
    "    return model.predict(X_new)[0]\n",
    "    fare = predict_fare(\n",
    "    \"2015-01-10 10:30:00\",\n",
    "    40.7614327,\n",
    "    -73.9798156,\n",
    "    40.6513111,\n",
    "    -73.8803331,\n",
    "    2)\n",
    "print(\"Predicted fare:\", round(fare, 2))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "584ec89b-624a-4fce-ae05-366aa6c850d9",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Predicted fare: 43.71\n"
     ]
    }
   ],
   "source": [
    "from datetime import datetime\n",
    "import pandas as pd\n",
    "def build_feature_row(\n",
    "    pickup_datetime_str,\n",
    "    pickup_latitude,\n",
    "    pickup_longitude,\n",
    "    dropoff_latitude,\n",
    "    dropoff_longitude,\n",
    "    passenger_count):\n",
    "    pickup_dt = datetime.strptime(pickup_datetime_str, \"%Y-%m-%d %H:%M:%S\")\n",
    "    pickup_year = pickup_dt.year\n",
    "    pickup_month = pickup_dt.month\n",
    "    pickup_day = pickup_dt.day\n",
    "    pickup_hour = pickup_dt.hour\n",
    "    pickup_weekday = pickup_dt.weekday()\n",
    "    distance_km = haversine_distance(\n",
    "        pickup_latitude,\n",
    "        pickup_longitude,\n",
    "        dropoff_latitude,\n",
    "        dropoff_longitude)\n",
    "    row = pd.DataFrame([{\n",
    "        \"pickup_year\": pickup_year,\n",
    "        \"pickup_month\": pickup_month,\n",
    "        \"pickup_day\": pickup_day,\n",
    "        \"pickup_hour\": pickup_hour,\n",
    "        \"pickup_weekday\": pickup_weekday,\n",
    "        \"passenger_count\": passenger_count,\n",
    "        \"distance_km\": distance_km}])\n",
    "    return row\n",
    "def predict_fare(\n",
    "    pickup_datetime_str,\n",
    "    pickup_latitude,\n",
    "    pickup_longitude,\n",
    "    dropoff_latitude,\n",
    "    dropoff_longitude,\n",
    "    passenger_count):\n",
    "    X_new = build_feature_row(\n",
    "        pickup_datetime_str,\n",
    "        pickup_latitude,\n",
    "        pickup_longitude,\n",
    "        dropoff_latitude,\n",
    "        dropoff_longitude,\n",
    "        passenger_count)\n",
    "    return model.predict(X_new)[0]\n",
    "fare = predict_fare(\n",
    "    \"2015-01-10 10:30:00\",\n",
    "    40.7614327,\n",
    "    -73.9798156,\n",
    "    40.6513111,\n",
    "    -73.8803331,2)\n",
    "print(\"Predicted fare:\", round(fare, 2))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b3020b84-3294-488a-abc9-fe3d494b1a87",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python (promptenv)",
   "language": "python",
   "name": "promptenv"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
